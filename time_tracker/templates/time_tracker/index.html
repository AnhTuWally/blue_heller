<!DOCTYPE html>
<html>
    <head>
        <title>{{title}} {{project.name}}</title>
        {% load static %}
        <script type="text/javascript" src="{% static 'jquery-3.6.4.min.js' %}"></script> 
        <script type="text/javascript" src="{% static 'bootstrap/js/bootstrap.min.js' %}"></script>

        <script type="text/javascript">

            function create_project() {
                var project_name = $("#project_name").val();

                if(project_name == ""){
                    alert("Please enter a project name");
                    return;
                }

                console.log(project_name)
                $.ajax({
                    type: "POST",
                    url: "{% url 'time_tracker:create_project' %}",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'project_name': project_name,
                    },
                    success: function (response) {
                        console.log(response);
                        $("#project_name").val("");
                        location.reload();
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
            }

            function delete_project(element) {
                var project_id = $(element).attr("project_id");

                console.log(project_name)
                $.ajax({
                    type: "POST",
                    url: "{% url 'time_tracker:delete_project' %}",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'project_id': project_id,
                    },
                    success: function (response) {
                        console.log(response);
                        location.reload();
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
            }

            function reload_project_detail(){
                var project_id = $('#project_detail_modal').attr('project_id');
                $.ajax({
                    type: "POST",
                    url: "{% url 'time_tracker:project_detail' %}",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'project_id': project_id,
                    },
                    success: function (response) {
                        $('#project_detail_modal').html(response);
                        $('#project_detail_modal').attr('project_id', project_id);
                        connect_task_event();
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
            }

            {% comment %} a javascript function that take the value of the input and do a post request to the server {% endcomment %}
            function create_task() {
                var task_name = $("#task_name").val();
                var project_id = $('#project_detail_modal').attr('project_id');
                
                console.log(project_id)

                if(task_name == ""){
                    alert("Please enter a task name");
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: "{% url 'time_tracker:create_task' %}",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'task_name': task_name,
                        'project_id': project_id,
                    },
                    success: function (response) {
                        console.log(response);
                        $("#task_name").val("");
                        reload_project_detail();
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
            }
            

            function start_task(element) {
                var task_id = $(element).attr('task_id');
                var user_id = $('.current_user').attr('user_id');

                console.log(user_id)
                
                if(task_id == ""){
                    alert("no valid task id");
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: "{% url 'time_tracker:create_task_timer' %}",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'task_id': task_id,
                        'user_id': user_id,
                    },
                    success: function (response) {
                        console.log(response);
                        reload_project_detail()
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
            }
            

            function stop_task(element) {
                var task_timer_id = $(element).attr('task_timer_id');
                var user_id = $('.current_user').attr('user_id');
                
                if(task_timer_id== ""){
                    alert("no valid task id");
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: "{% url 'time_tracker:stop_task_timer' %}",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'task_timer_id': task_timer_id,
                        'user_id': user_id
                    },
                    success: function (response) {
                        console.log(response);
                        reload_project_detail(); 
                        
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
            }
            
            function delete_timer(element) {
                var task_timer_id = $(element).attr('task_timer_id');
                
                var task_id = $('.task_detail_modal').attr('task_id');

                if(task_timer_id== ""){
                    alert("no valid task id");
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: "{% url 'time_tracker:delete_task_timer' %}",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'task_timer_id': task_timer_id,
                    },
                    success: function (response) {
                        console.log(response);
                        {% comment %} open_task(task_id); {% endcomment %}
                        reload_project_detail();
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
            }
            

            function timer() {
                var timers = $(".timer");
                for (var i = 0; i < timers.length; i++) {
                    var timer = timers[i];
                    var start_time = $(timer).attr('start_time')*1000;
                    var current_time = new Date().getTime();
                    var time = current_time - start_time;

                    var hours = Math.floor((time % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    var minutes = Math.floor((time % (1000 * 60 * 60)) / (1000 * 60));
                    var seconds = Math.floor((time % (1000 * 60)) / 1000);
                    var milliseconds = Math.floor((time % (1000 * 60)) / 100);
                    $(timer).html(hours + ":" + minutes + ":" + seconds);
                }
            }

            function edit_timer(element){

                var ttid = $(element).attr('task_timer_id');
                current_start_time = $(`.start_time[task_timer_id="${ttid}"]`).html().trim();
                current_end_time = $(`.end_time[task_timer_id="${ttid}"]`).html().trim();
                $(`.start_time[task_timer_id="${ttid}"]`).html(`<input type="text" class='start_time_edit' task_timer_id="${ttid}" value="${current_start_time}">`);
                $(`.end_time[task_timer_id="${ttid}"]`).html(`<input type="text" class='end_time_edit' task_timer_id="${ttid}" value="${current_end_time}">`);
            }

            function send_edit_timer(element){

                var ttid = $(element).attr('task_timer_id');

                var task_id = $('.task_detail_modal').attr('task_id');
                start_time_value = $(`.start_time_edit[task_timer_id="${ttid}"]`).val().trim();
                end_time_value = $(`.end_time_edit[task_timer_id="${ttid}"]`).val().trim();

                $.ajax({
                    type: "POST",
                    url: "{% url 'time_tracker:edit_task_timer' %}",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'task_timer_id': ttid,
                        'start_time_value': start_time_value,
                        'end_time_value': end_time_value,
                    },
                    success: function (response) {
                        console.log(response);
                        reload_project_detail();
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });

            }

            function unbine_task_event(){
                $('.open_project_button').unbind();

                $("#create_task_button").unbind();
                $("#task_name").unbind();
                $(".start_task_button").unbind();
                $(".stop_task_button").unbind();
                $(".delete_timer_button").unbind();
                $('.edit_timer_button').unbind();
                $('.send_edit_timer_button').unbind();
                $('.delete_task_button').unbind();
                $('.view_task_button').unbind();
            }

            function connect_task_event(){
                
                unbine_task_event();

                $('.open_project_button').click(function () {
                    open_project(this);
                });

                $("#create_task_button").click(function () {
                    console.log("Sending request to create task");
                    create_task();
                });

                $("#task_name").keypress(function (e) {
                    if (e.which == 13) {
                        create_task();
                    }
                });

                $(".start_task_button").click(function () {
                    start_task(this);
                });

                $(".stop_task_button").click(function () {
                    stop_task(this);
                });

                $(".delete_timer_button").click(function () {
                    delete_timer(this);
                });


                $('.edit_timer_button').click(function () {
                    edit_timer(this);
                });

                $('.send_edit_timer_button').click(function () {
                    send_edit_timer(this);
                });
                
                $(".view_task_button").click(function () {

                    var task_id = $(this).attr('task_id');
                    
                    open_task(task_id);
                });

                $(".delete_task_button").click(function () {
                    delete_task(this);
                });
            }

            function open_project(element) {
                var project_id = $(element).attr('project_id');

                console.log(project_id)

                $.ajax({
                    type: "POST",
                    url: "{% url 'time_tracker:project_detail' %}",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'project_id': project_id,
                    },
                    success: function (response) {
                        console.log(response);
                        $("#project_detail_modal").html(response);
                        $("#project_detail_modal").attr('project_id', project_id);

                        connect_task_event()
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
            }

            
            function open_task(task_id) {

                $.ajax({
                    type: "POST",
                    url: "{% url 'time_tracker:task_detail' %}",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'task_id': task_id,
                    },
                    success: function (response) {
                        console.log(response);
                        $("#task_detail_modal").html(response);
                        $("#task_detail_modal").attr('task_id', task_id);

                        connect_task_event();
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
            }
            
            
            function delete_task(element) {
                var task_id = $(element).attr('task_id');

                $.ajax({
                    type: "POST",
                    url: "{% url 'time_tracker:delete_task' %}",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'task_id': task_id,
                    },
                    success: function (response) {
                        console.log(response);
                        reload_project_detail();
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
            }
            
            function create_user() {
                var username = $(".username").val();
                console.log(username)

                $.ajax({
                    type: "POST",
                    url: "{% url 'time_tracker:create_user' %}",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                        'username': username,
                    },
                    success: function (response) {
                        console.log(response);
                        $(".username").val("");
                        $(".current-user").html(response);
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
            }

            $(document).ready(function() {
                $("#create_project_button").click(function () {
                    console.log("Sending request to create project");
                    create_project();
                });


                $("#project_name").keypress(function (e) {
                    if (e.which == 13) {
                        create_project();
                    }
                });

                $(".delete_project_button").click(function () {
                    console.log("Sending request to delete project");
                    delete_project(this);
                });

                $('.open_project_button').click(function () {
                    open_project(this);
                });

                $('.create_user_button').click(function () {
                    console.log("USER NAME creating")
                    create_user();
                });

                console.log("ready");

                setInterval(timer, 1000);
            })


            

        </script>

        <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">

        <style>
            .task-container {
                display: flex;
                flex-wrap: wrap;
                margin: 10px;
                border: 1px solid black;
                justify-content: center;
            }

            .task-item{
                margin:10px; 
                text-align:center;
                border: 1px solid green;
                min-width: 300px;
            }
        </style>
    </head>

    <body>
   <div style="display:flex;"> 
       <div>
           <div class="user-selection">
               <div class="current_user" user_id = {{ current_user.id }}>
                   {{ current_user.name }}
               </div>
               <div>
                   <input type="text" class='username' placeholder='howdy'> 
               </div>
               <div>
                   <button type="submit" class="btn btn-primary create_user_button">Login</button>
               </div>
           </div>
           <div class="bg-dark text-primary" style='width:300px;'>
               <div class="list-group list-group-flush border-bottom scrollarea" style="width:250px;">
                   <div>
                       <div class="new-project-input">
                           <input type="text" class="form-control" id="project_name" placeholder="start something">
                       </div>
                       <div class="new-project-button">
                           <button type="submit" class="btn btn-primary" id="create_project_button">New Project</button>
                       </div>
                   </div>
                   {% for project in project_list %}
                       <div style="display:flex">
                           <a class="list-group-item list-group-item-action py-3 lh-tight open_project_button" project_id = {{project.id}} >
                               <strong class="mb-1">{{project.name}}</strong>
                           </a>
                           <button type="submit" class="btn btn-danger delete_project_button" project_id={{project.id}}>X</button>
                       </div>
                   {% endfor %}
               </div>

           </div>
       </div>
       <div id="project_detail_modal" project_id=''>
       </div>
   </div>

    </body>
</html>